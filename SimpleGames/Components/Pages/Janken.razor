@page "/janken"
@using JankenGame.Models.Janken
@using JankenGame.Services.Janken
@rendermode InteractiveServer

<h3>ã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ </h3>

@if (HasError)
{
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
        <p>@ErrorMessage</p>
        <hr>
        <div class="d-flex gap-2">
            <button class="btn btn-warning" @onclick="RecoverFromError">ã‚²ãƒ¼ãƒ ã‚’å†é–‹</button>
            <button class="btn btn-secondary" @onclick="ResetGameFromError">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
        </div>
    </div>
}

<div class="game-setup">
    <div class="player-count-control">
        <label>å¯¾æˆ¦äººæ•° (ã‚ãªãŸã‚’å«ã‚€): </label>
        <select value="@selectedPlayerCount.ToString()" @onchange="OnPlayerCountChanged" disabled="@AllPlayersHandReady" aria-label="å¯¾æˆ¦äººæ•°ã‚’é¸æŠ">
            <option value="2">2äºº</option>
            <option value="3">3äºº</option>
            <option value="4">4äºº</option>
            <option value="5">5äºº</option>
            <option value="6">6äºº</option>
        </select>
    </div>
</div>

<div class="choices">
    <button @onclick="() => Play(JankenHand.Rock)" disabled="@AllPlayersHandReady" aria-label="ã‚°ãƒ¼ã‚’é¸æŠ">âœŠ ã‚°ãƒ¼</button>
    <button @onclick="() => Play(JankenHand.Paper)" disabled="@AllPlayersHandReady" aria-label="ãƒ‘ãƒ¼ã‚’é¸æŠ">âœ‹ ãƒ‘ãƒ¼</button>
    <button @onclick="() => Play(JankenHand.Scissors)" disabled="@AllPlayersHandReady" aria-label="ãƒãƒ§ã‚­ã‚’é¸æŠ">âœŒï¸ ãƒãƒ§ã‚­</button>
</div>

@if (AllPlayersHandReady)
{
    <div class="result">
        <div class="hands-display">
            <h4>å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹</h4>
            @foreach (var player in Players)
            {
                <div class="player-hand">
                    <strong>@player.Name</strong>: @player.Hand?.GetDescription()
                </div>
            }
        </div>
        
        <div class="game-result">
            <p class="outcome-message">@OutcomeMessage</p>
            
            @if (LastGameResult?.WinningHand != null)
            {
                <div class="winners">
                    <p><strong>å‹è€…:</strong> @string.Join(", ", LastGameResult.WinnerIds.Select(id => GetPlayerName(id)))</p>
                </div>
            }
        </div>

        <button @onclick="ResetGame" aria-label="ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
}

<div class="score-board">
    <h4>ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰</h4>
    <table class="table">
        <thead>
            <tr>
                <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
                <th>å‹</th>
                <th>æ•—</th>
                <th>å¼•ãåˆ†ã‘</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var player in Players)
            {
                <tr>
                    <td>@player.Name</td>
                    <td>@RecordList.GetWins(player.Id)</td>
                    <td>@RecordList.GetLosses(player.Id)</td>
                    <td>@RecordList.GetDraws(player.Id)</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (RecentRecords.Any())
{
    <div class="history">
        <h4>ç›´è¿‘ã®å±¥æ­´ï¼ˆæœ€å¤§5ä»¶ï¼‰</h4>
        <ul>
            @foreach (var record in RecentRecords)
            {
                <li>
                    @foreach (var kvp in record.PlayerHands)
                    {
                        var playerName = GetPlayerName(kvp.Key);
                        <span>@playerName: @kvp.Value.GetDescription() / </span>
                    }
                    @if (record.WinningHand is { } winningHand)
                    {
                        <span>â†’ å‹ã¡æ‰‹: @winningHand.GetDescription()</span>
                    }
                    else
                    {
                        <span>â†’ å¼•ãåˆ†ã‘</span>
                    }
                    <span>ï¼ˆ@record.Timestamp.ToString("HH:mm:ss")ï¼‰</span>
                </li>
            }
        </ul>
    </div>
}

@code {
    private const int MaxHistoryCount = 5;
    private const int HumanPlayerIndex = 0;
    private const int FirstComputerPlayerIndex = 1;
    private const string HumanPlayerName = "ã‚ãªãŸ";
    private const string ComputerPlayerNameFormat = "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼{0}";

    private int selectedPlayerCount = 3;
    private string OutcomeMessage = "";
    private MultiPlayerGameRecord? LastGameResult = null;
    
    // ã‚¨ãƒ©ãƒ¼ç®¡ç†
    private bool HasError = false;
    private string ErrorMessage = "";

    private List<JankenPlayer> Players = new();
    private List<MultiPlayerGameRecord> RecordList = new();
    private Random rnd = new();
    private JankenGameService gameService = new();

    private bool AllPlayersHandReady => Players.All(p => p.Hand != null);
    private IEnumerable<MultiPlayerGameRecord> RecentRecords => RecordList.OrderByDescending(r => r.Timestamp).Take(MaxHistoryCount);

    protected override void OnInitialized()
    {
        InitializePlayers();
    }

    /// <summary>
    /// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹
    /// é¸æŠã•ã‚ŒãŸäººæ•°ã«å¿œã˜ã¦ã€1äººã®äººé–“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨è¤‡æ•°ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã™ã‚‹
    /// </summary>
    private void InitializePlayers()
    {
        Players.Clear();
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæœ€åˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
        var humanPlayer = new JankenPlayer(HumanPlayerName, JankenPlayerType.Human);
        Players.Add(humanPlayer);
        
        // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
        for (int i = FirstComputerPlayerIndex; i < selectedPlayerCount; i++)
        {
            var computerPlayer = new JankenPlayer(string.Format(ComputerPlayerNameFormat, i), JankenPlayerType.Computer);
            Players.Add(computerPlayer);
        }
    }

    private void OnPlayerCountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int count))
        {
            selectedPlayerCount = count;
            RecordList.Clear();
            InitializePlayers();
            ResetGame();
            StateHasChanged();
        }
    }

    /// <summary>
    /// ã‚²ãƒ¼ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®æ‰‹ã‚’æ±ºå®šã—ã€å‹è€…ã‚’åˆ¤å®š
    /// </summary>
    /// <param name="userJankenHand">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸæ‰‹ï¼ˆã‚°ãƒ¼/ãƒ‘ãƒ¼/ãƒãƒ§ã‚­ï¼‰</param>
    private void Play(JankenHand userJankenHand)
    {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹ã‚’å‡ºã™
        Players[HumanPlayerIndex].Hand = userJankenHand;

        // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãŒãƒ©ãƒ³ãƒ€ãƒ ã«æ‰‹ã‚’å‡ºã™
        // å…¨ã¦ã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¯¾ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ãªæ‰‹ã‚’å‰²ã‚Šå½“ã¦ã‚‹
        var jankenHands = Enum.GetValues<JankenHand>();
        for (int i = FirstComputerPlayerIndex; i < Players.Count; i++)
        {
            Players[i].Hand = jankenHands[rnd.Next(jankenHands.Length)];
        }

        // å‹è€…ã‚’åˆ¤å®š
        DetermineWinner();
    }

    /// <summary>
    /// è¤‡æ•°äººã˜ã‚ƒã‚“ã‘ã‚“ã®å‹è€…ã‚’åˆ¤å®šã™ã‚‹
    /// 
    /// åˆ¤å®šãƒ«ãƒ¼ãƒ«:
    /// - å…¨å“¡åŒã˜æ‰‹ã€ã¾ãŸã¯3ç¨®é¡å…¨ã¦ãŒå‡ºãŸå ´åˆ: å¼•ãåˆ†ã‘
    /// - 2ç¨®é¡ã®æ‰‹ãŒå‡ºãŸå ´åˆ: ã˜ã‚ƒã‚“ã‘ã‚“ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦å‹è€…ã‚’æ±ºå®š
    /// - åŒã˜æ‰‹ã‚’å‡ºã—ãŸè¤‡æ•°ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‹è€…ã«ãªã‚‹å ´åˆãŒã‚ã‚‹ï¼ˆåŒæ™‚å‹åˆ©ï¼‰
    /// 
    /// ã‚²ãƒ¼ãƒ çµæœã¯RecordListã«è¨˜éŒ²ã•ã‚Œã€UIã«è¡¨ç¤ºã•ã‚Œã‚‹
    /// </summary>
    private void DetermineWinner()
    {
        if (!AllPlayersHandReady)
        {
            OutcomeMessage = "æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
            return;
        }

        try
        {
            // JankenGameServiceã‚’ä½¿ç”¨ã—ã¦è¤‡æ•°äººå¯¾æˆ¦ã®å‹è€…ã‚’åˆ¤å®š
            // winningHand: å‹ã£ãŸæ‰‹ï¼ˆå¼•ãåˆ†ã‘ã®å ´åˆã¯nullï¼‰
            // winnerIds: å‹è€…ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDãƒªã‚¹ãƒˆï¼ˆå¼•ãåˆ†ã‘ã®å ´åˆã¯å…¨å“¡ï¼‰
            var (winningHand, winnerIds) = gameService.DetermineMultiPlayerWinner(Players);
            
            // è¨˜éŒ²ã‚’è¿½åŠ ï¼ˆçµ±è¨ˆã¨ã‚²ãƒ¼ãƒ å±¥æ­´ï¼‰
            var playerHands = Players.ToDictionary(p => p.Id, p => p.Hand!.Value);
            var record = MultiPlayerGameRecordHelper.AddRecord(playerHands, winningHand, winnerIds);
            RecordList.Add(record);

            LastGameResult = record;

            // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
            if (winningHand == null)
            {
                OutcomeMessage = "å¼•ãåˆ†ã‘ï¼";
            }
            else
            {
                var winnerNames = string.Join(", ", winnerIds.Select(id => GetPlayerName(id)));
                OutcomeMessage = $"{winnerNames}ã®å‹ã¡ï¼ğŸ‰";
            }
        }
        catch (ArgumentException)
        {
            // å…¥åŠ›å€¤ã®å•é¡Œ
            SetError("äºˆæœŸã—ãªã„å…¥åŠ›ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        }
        catch (InvalidOperationException)
        {
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®å•é¡Œ
            SetError("ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ãŒä¸æ­£ã§ã™ã€‚ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        }
        catch (Exception ex)
        {
            // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
            SetError($"äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚{ex.Message}");
        }
    }

    private void ResetGame()
    {
        foreach (var player in Players)
        {
            player.Hand = null;
        }
        OutcomeMessage = "";
        LastGameResult = null;
    }

    private string GetPlayerName(string id)
    {
        return Players.FirstOrDefault(p => p.Id == id)?.Name ?? "ä¸æ˜";
    }

    private void SetError(string message)
    {
        HasError = true;
        ErrorMessage = message;
        OutcomeMessage = "";
    }

    private void RecoverFromError()
    {
        // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ã—ã¦ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
        HasError = false;
        ErrorMessage = "";
        ResetGame();
    }

    private void ResetGameFromError()
    {
        // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ã—ã¦å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆ
        HasError = false;
        ErrorMessage = "";
        RecordList.Clear();
        InitializePlayers();
        ResetGame();
    }
}
